# CLAUDE.md — geldbeutel V1.0

## System Identity

**geldbeutel V1.0** — Thermodynamic Discrete Liquidity Sweep (TTDLS) engine for MNQ/NQ futures.

| Parameter | Value |
|-----------|-------|
| Instrument | MNQ (Micro E-mini Nasdaq 100) |
| Timeframe | 5-minute bars, 24/5 session |
| Data Source | Dukascopy CFD (`USATECHIDXUSD`), pre-quantized to MNQ tick grid |
| Tick Size | 0.25 points |
| Point Value | $2.00 per point per contract |
| Risk Per Trade | 1% of equity |
| Max Contracts | 20 (hard margin cap) |
| Optimization | Mixed-Integer GA inside Rolling Walk-Forward |

**Status**: Kernel sealed. Data pipeline active. WFO matrix built, awaiting data completion.

never present fabricated data

---

## Theory Reference

Full mathematical derivation: `C:\Users\Pfenn\OneDrive\Desktop\notes\Theorie .txt`

The system implements the **Thermodynamic Theory of Discrete Liquidity Sweeps (TTDLS)**: alpha is extracted by defining physical boundaries of resting liquidity, measuring depth and velocity of institutional absorption, and executing asymmetric timeframe arbitrage at the moment of structural reclaim.

---

## Architecture

```
geldbeutel/V1.0/
├── wfo_matrix.py              # Sealed kernel + GA + Rolling WFO (main entry point)
├── dukascopy_downloader.py    # Tick → 5-min bar data pipeline
├── NQ_CFD_5min_2017_2026.parquet  # Output data (generated by downloader)
├── wfo_equity_curve.parquet       # OOS compounding curve (generated by WFO)
├── wfo_window_results.csv         # Per-window results (generated by WFO)
└── CLAUDE.md                      # This file
```

---

## The 6-Dimensional Genome

The kernel has exactly 6 degrees of freedom. No indicators. No moving averages. Pure order-book physics.

| Gene | Symbol | Type | Range | Physical Meaning |
|------|--------|------|-------|------------------|
| Macro Lookback | `w` | int | [72, 576] | Structural scope (6h–48h in 5-min bars) |
| Anchor Maturity | `m` | int | [6, 144] | Min age for pivot to accumulate stops (30min–12h) |
| Min Sweep Depth | `d_min` | float | [0.02, 0.50] | Min % pierce below anchor (stop-trigger threshold) |
| Max Excursion | `d_max` | float | [0.10, 2.00] | Max % before hypothesis dies (limit bids overrun) |
| Reclaim Velocity | `v` | int | [1, 10] | Max bars allowed to close below before invalidation |
| Reward Asymmetry | `beta` | float | [1.0, 8.0] | R-multiple for take-profit |

**Constraint**: `w > m`, `d_min < d_max`, `v >= 1`, `beta > 0.5`. Violations return fitness -999999.

---

## The State Machine (T+0 Causal Loop)

Each bar `t` executes three phases in strict sequence:

1. **PHASE 1 — T+0 OPEN**: Resolve pending orders at `open[t]`. Gap-trap filter validates thesis. Slippage applied to entry.
2. **PHASE 2 — T+0 INTRABAR**: Execute stops/targets with chronological priority (gap first, then wick). Mark-to-market if no fill. Bypass signal generation while in a trade.
3. **PHASE 3 — T+0 CLOSE**: Structural mapping. Scan for pristine anchors. Detect breach → vacuum → reclaim. RTH-only ignition (09:30–16:00 ET).

State transitions (described for longs, shorts are inversely identical):
- **S=0 HUNTING**: Find lowest pristine pivot in `[t-w, t-m]`. If `low[t] < L*` and `close[t-1] >= L*` → enter S=1.
- **S=1 VACUUM**: Track `E_min`. Check gates in order: depth death → time death → reclaim → increment tau.
- **Signal**: Reclaim during RTH with `d_min <= delta <= d_max` → pending execution at next open.

---

## Critical Implementation Details

### Temporal Integrity (CRITICAL — NO EXCEPTIONS)

- **No look-ahead**: Pristine check scans `[min_idx+1, t)` — up to but NOT including current bar
- **Pending execution**: Signal at close of bar `t` → execution at open of bar `t+1`
- **Gap-trap filter**: If open gaps through the level against the thesis, trade is aborted
- **Overhang memory**: WFO feeds `w` bars of pre-OOS data for structural mapping, but locks execution until OOS start

### Thermodynamic Friction (Pessimistic Physics)

- **Pre-quantization**: All OHLC snapped to 0.25 tick grid before any computation
- **Slippage**: 0.50 points (2 ticks) on every market order entry AND every stop exit
- **Commission**: $1.00 per contract round-trip
- **MIN_RISK_PTS**: 2.00 — eliminates bid/ask micro-scalp exploits
- **TP requires pierce**: `high >= tp + TICK` (limit order FIFO queue reality)

### Fitness Function (Dual-Gradient)

```python
if net < 0:
    return net - dd    # Monotonic negative gradient: more loss + more DD = worse
return net / dd        # Calmar ratio for profitable genomes
```

- **Below zero**: Subtraction prevents GA from weaponizing large drawdowns to shrink negative fractions
- **Above zero**: Standard Calmar selects for edge-per-unit-risk
- **Min trades**: 30 (statistical significance gate)

### Tau Causality (Gate Order)

```
1. Check delta > d_max       → kill (depth death)
2. Check tau > v             → kill (time death)
3. Check close > L*          → reclaim (signal if valid)
4. ELSE: tau += 1            → increment (failed reclaim)
```

Increment happens ONLY on failed reclaim. Gene `v=1` allows exactly 1 close-below, `v=2` allows exactly 2. 1:1 mapping.

---

## Development Commands

```bash
# Install dependencies
pip install numpy pandas numba pyarrow

# Download 5-min NQ CFD data (Dukascopy, ~60-90 min)
python dukascopy_downloader.py

# Run full WFO matrix (after data download completes)
python wfo_matrix.py

# Quick kernel test (Numba warmup + single genome eval)
python -c "
from wfo_matrix import *
import numpy as np
d = np.ones(2000)
m = np.full(2000, 600, dtype=np.int64)
eq, tr = absolute_liquidity_sweep_engine(d, d, d, d, m, 100, 10, 0.1, 0.5, 2, 2.0)
print(f'Bars: {len(eq)}, Trades: {tr}')
"
```

---

## Data Pipeline

### Source
- **Instrument**: `USATECHIDXUSD` (Dukascopy Nasdaq 100 CFD)
- **Resolution**: Tick data → aggregated to 5-minute OHLCV bars
- **Range**: 2017-01-01 to 2026-02-22
- **Timestamps**: UTC (converted to US/Eastern at runtime for RTH gating)
- **Volume**: Tick count per 5-min bar (CFD has no real exchange volume)
- **Storage**: Parquet only (disk space conservation)

### Why CFD Data Works
The pessimistic friction layer (2-tick slippage, commission, MIN_RISK_PTS, d_min depth gate) makes the 1–2 point CFD tracking error statistically irrelevant. If the GA finds an edge through this friction, the real CME order book is a frictionless vacuum.

### Loading Data
```python
import pandas as pd
df = pd.read_parquet("NQ_CFD_5min_2017_2026.parquet")
df.index = df.index.tz_localize('UTC').tz_convert('US/Eastern')
q_o, q_h, q_l, q_c, mod = quantize_and_align_data(df)
```

---

## Walk-Forward Optimization Protocol

| Parameter | Value |
|-----------|-------|
| Training window | 6 months |
| Trading window | 3 months (true OOS) |
| Overhang | `w` bars pre-OOS for structural mapping |
| GA population | 80 genomes |
| GA generations | 40 |
| Selection | Tournament (k=3) |
| Crossover | Simulated Binary (SBX, eta=2) |
| Mutation | Polynomial (15% rate) + integer snapping |
| Elitism | Top 10% carry forward |
| Min trades for fitness | 30 |
| OOS stitching | Compounding (scaled to running capital) |

### WFO Cycle
1. Train on `[t-6mo, t)` → GA evolves apex genome
2. Lock genome → trade `[t, t+3mo)` on unseen data
3. Stitch OOS equity into global compounding curve
4. Slide window forward 3 months → repeat

---

## Output Files

| File | Contents |
|------|----------|
| `NQ_CFD_5min_2017_2026.parquet` | 5-min OHLCV bars, ~600k rows, UTC index |
| `NQ_CFD_5min_2017_2026_checkpoint.parquet` | Download checkpoint (deleted on completion) |
| `wfo_equity_curve.parquet` | Global OOS compounding equity curve |
| `wfo_window_results.csv` | Per-window: genome, fitness, OOS net, OOS DD, Calmar, trades |

---

## Key Performance Metrics

1. **OOS Calmar Ratio**: Net profit / max drawdown on unseen data (target > 1.0)
2. **Profitable Windows**: % of WFO windows with positive OOS net (target > 55%)
3. **Global Max DD**: Worst peak-to-trough on the stitched compounding curve
4. **Trade Count**: Must exceed 30 per IS window for statistical significance
5. **Regime Stability**: Genome parameter drift across windows indicates regime change

---

## Known Constraints

| Constraint | Mitigation |
|------------|------------|
| Dukascopy CFD != CME futures | Pessimistic friction layer absorbs tracking error |
| No real exchange volume | Tick count as proxy; volume not used in kernel logic |
| Disk space limited (~10 GB free) | Parquet only, no CSV, checkpoint cleanup |
| Numba JIT first-call latency | Warmup with dummy data before timing |
| GA is stochastic | Seed per window for reproducibility; elitism preserves best |
| Static 1% risk sizing | Could extend to Kelly criterion post-validation |

---

## Relationship to Other Systems

| System | Location | Purpose | Interaction |
|--------|----------|---------|-------------|
| **TRAnS** | `vonLinck Capital/trans/` | Daily equity consolidation breakouts (EU) | Independent — different asset class and timeframe |
| **AIv3** | `AI Infra/` root | Stock pattern detection (XGBoost) | Independent — geldbeutel is futures-only |
| **Monster Hunter** | `geldbeutel/Test/monster_hunter/` | Micro-cap 2x bagger prototype | Research predecessor; superseded by V1.0 |
| **TTDLS Theory** | `Desktop/notes/Theorie .txt` | Mathematical foundation | V1.0 is the implementation of this theory |
